@model IEnumerable<EcommerceStore.Models.ApplicationUser>
@using Microsoft.AspNetCore.Identity

@{
    ViewData["Title"] = "User Management";
}

<h2>User Management (SuperAdmin Only)</h2>
<a asp-action="Create" class="btn btn-primary mb-3">➕ Add New User</a>


<table class="table table-striped">
    <thead>
        <tr>
            <th>Email</th>
            <th>Full Name</th>
            <th>Role</th>
            <th>Status</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var user in Model)
        {
            <tr>
                <td>@user.Email</td>
                <td>@user.FullName</td>
                <td>
                    @{
                        var roles = await Context.RequestServices
                        .GetService<UserManager<EcommerceStore.Models.ApplicationUser>>()
                        .GetRolesAsync(user);
                        string role = roles.FirstOrDefault() ?? "Customer";
                    }
                    @role
                </td>
                <td>
                    @(user.LockoutEnd.HasValue && user.LockoutEnd > DateTimeOffset.Now
                        ? "Inactive"
                        : "Active")
                </td>
                <td>
                    <!-- Assign Role -->
                    <form asp-action="AssignRole" method="post" style="display:inline;">
                        <input type="hidden" name="userId" value="@user.Id" />
                        <select name="role" class="form-select form-select-sm d-inline w-auto">
                            <option value="Customer">Customer</option>
                            <option value="Admin">Admin</option>
                            <option value="SuperAdmin">SuperAdmin</option>
                        </select>
                        <button type="submit" class="btn btn-sm btn-primary">Set Role</button>
                    </form>

                    <!-- Toggle Activation -->
                    <form asp-action="ToggleActivation" method="post" style="display:inline;">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="userId" value="@user.Id" />
                        <button type="submit" class="btn btn-sm @(user.LockoutEnd.HasValue && user.LockoutEnd > DateTimeOffset.Now ? "btn-success" : "btn-danger")">
                            @(user.LockoutEnd.HasValue && user.LockoutEnd > DateTimeOffset.Now ? "Activate" : "Deactivate")
                        </button>
                    </form>
                </td>
                <td>
                    <!-- Assign Role -->
                    <form asp-action="AssignRole" method="post" style="display:inline;">
                        <input type="hidden" name="userId" value="@user.Id" />
                        <select name="role" class="form-select form-select-sm d-inline w-auto">
                            <option value="Customer">Customer</option>
                            <option value="Admin">Admin</option>
                            <option value="SuperAdmin">SuperAdmin</option>
                        </select>
                        <button type="submit" class="btn btn-sm btn-primary">Set Role</button>
                    </form>

                    <!-- Toggle Activation -->
                    <form asp-action="ToggleActivation" method="post" style="display:inline;">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="userId" value="@user.Id" />
                        <button type="submit" class="btn btn-sm @(user.LockoutEnd.HasValue && user.LockoutEnd > DateTimeOffset.Now ? "btn-success" : "btn-danger")">
                            @(user.LockoutEnd.HasValue && user.LockoutEnd > DateTimeOffset.Now ? "Activate" : "Deactivate")
                        </button>
                    </form>

                    <!-- Edit User -->
                    <a asp-action="Edit" asp-route-id="@user.Id" class="btn btn-warning btn-sm">Edit</a>

                    <!-- Delete User -->
                    <a asp-action="Delete" asp-route-id="@user.Id" class="btn btn-danger btn-sm"
                       onclick="return confirm('Are you sure you want to delete this user?');">Delete</a>
                </td>
            </tr>
        }
    </tbody>
</table>
